/**
 * Core Philosophy: This ruleset enforces a strict security model centered around
 * user actions and data ownership. Public data, such as products and blog posts, is
 * readable by anyone but can only be modified by backend services (client writes are disabled).
 * User-specific data, like customer profiles and orders, is private and accessible
 * only to the owning user.
 *
 * Data Structure: The data is organized into logical top-level collections:
 * `/customers/{customerId}` for user profiles, `/products/{productId}` for catalog items,
 * `/orders/{orderId}` for purchase records, and `/blogPosts/{blogPostId}` for content.
 * Critical relationships are modeled as subcollections, such as
 * `/products/{productId}/reviews/{reviewId}` and `/orders/{orderId}/orderItems/{orderItemId}`.
 *
 * Key Security Decisions:
 * - Verified Customer Reviews: The central feature is ensuring only customers who
 *   have purchased a product can review it. This is enforced on review creation
 *   by requiring the client to provide a `proofOfPurchaseOrderId`. The rules then
 *   verify that this order belongs to the user and contains the product being reviewed.
 * - Denormalization for Authorization: To enable the purchase verification check
 *   efficiently, it is assumed that each `/orders/{orderId}` document contains a
 *   denormalized array of product IDs from that order (e.g., `productIds: ["prod_A", "prod_B"]`).
 *   This avoids slow or impossible queries within security rules.
 * - Private User Data: User profiles (`/customers`) and orders (`/orders`) are strictly
 *   private. Listing all customers is disabled to prevent user enumeration.
 * - Admin-Managed Content: Products and blog posts are considered admin-managed content.
 *   All direct write operations from clients are disallowed to maintain data integrity.
 *   These collections should be managed via a trusted backend server using the Admin SDK.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /***********************************************************
     *                                                         *
     *                      HELPER FUNCTIONS                   *
     *                                                         *
     ***********************************************************/

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update/delete.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if the owner field of a document is immutable during an update.
     */
    function isOwnerFieldImmutable(fieldName) {
      return request.resource.data[fieldName] == resource.data[fieldName];
    }
    
    /**
     * Verifies that a user has purchased a specific product.
     * This check is critical for creating a product review.
     *
     * @param productId The ID of the product being reviewed.
     * @param proofOrderId The ID of an order submitted by the client as proof of purchase.
     *
     * ASSUMPTION: The /orders/{orderId} document MUST contain a denormalized
     * array of product IDs called `productIds` for this rule to work.
     * e.g., { customerId: 'user123', productIds: ['prod_abc', 'prod_xyz'] }
     */
    function hasPurchasedProduct(productId, proofOrderId) {
      let orderDoc = get(/databases/$(database)/documents/orders/$(proofOrderId));
      return orderDoc != null
        && orderDoc.data.customerId == request.auth.uid
        && productId in orderDoc.data.productIds;
    }
    
    /**
     * Checks if the current user owns the parent Order document.
     * Used to secure the orderItems subcollection.
     */
    function isOrderOwner(orderId) {
      let orderDoc = get(/databases/$(database)/documents/orders/$(orderId));
      return orderDoc != null && isOwner(orderDoc.data.customerId);
    }


    /***********************************************************
     *                                                         *
     *                     COLLECTION RULES                    *
     *                                                         *
     ***********************************************************/

    /**
     * @description Manages customer profile data.
     * @path /customers/{customerId}
     * @allow (create) A new user can create their own customer profile.
     * @allow (get, update) A user can read and update their own profile.
     * @deny (list, delete) Users cannot list all other customers or delete profiles.
     * @principle Restricts access to a user's own data tree.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isOwner(customerId) && request.resource.data.id == customerId;
      allow update: if isOwner(customerId) && isOwnerFieldImmutable('id');
      allow delete: if false;
    }

    /**
     * @description Manages product catalog information.
     * @path /products/{productId}
     * @allow (get, list) Anyone, including unauthenticated users, can view products.
     * @deny (create, update, delete) All client-side writes are forbidden to protect catalog integrity.
     * @principle Enforces public read access for data managed by a trusted backend.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;

      /**
       * @description Manages product reviews. Reviews are public, but creating them requires
       *              proof of purchase, and editing is restricted to the author.
       * @path /products/{productId}/reviews/{reviewId}
       * @allow (get, list) Anyone can read product reviews.
       * @allow (create) A signed-in user who has purchased the product can write a review.
       * @deny (create) A user attempts to review a product they have not purchased.
       * @deny (update) A user tries to edit another user's review.
       * @principle Enforces conditional writes based on cross-collection data verification.
       */
      match /reviews/{reviewId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid && request.resource.data.productId == productId && hasPurchasedProduct(productId, request.resource.data.proofOfPurchaseOrderId);
        allow update: if isExistingOwner(resource.data.customerId) && isOwnerFieldImmutable('customerId') && isOwnerFieldImmutable('productId');
        allow delete: if isExistingOwner(resource.data.customerId);
      }

      /**
        * @description Manages questions and answers for a product.
        * @path /products/{productId}/questions/{questionId}
        * @allow (read) Anyone can read questions and answers.
        * @allow (create) Any authenticated user can ask a question.
        * @allow (update) The author of a question can edit their own question.
        */
      match /questions/{questionId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid;
        allow update: if isExistingOwner(resource.data.customerId) && isOwnerFieldImmutable('customerId');
        allow delete: if isExistingOwner(resource.data.customerId);

        /**
          * @description Manages answers to a specific question.
          * @path /products/{productId}/questions/{questionId}/answers/{answerId}
          * @allow (read) Anyone can read answers.
          * @allow (create) Any authenticated user can post an answer.
          * @allow (update) The author of an answer can edit their own answer.
          */
        match /answers/{answerId} {
          allow get: if true;
          allow list: if true;
          allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid;
          allow update: if isExistingOwner(resource.data.customerId) && isOwnerFieldImmutable('customerId');
          allow delete: if isExistingOwner(resource.data.customerId);
        }
      }
    }

    /**
     * @description Manages orders placed by customers.
     * @path /orders/{orderId}
     * @allow (get, update, delete) A user can manage their own orders.
     * @deny (get) A user cannot read another user's order.
     * @deny (list) Unauthenticated users cannot list orders. Authenticated users must query for their own.
     * @principle Enforces document ownership for all operations.
     */
    match /orders/{orderId} {
      allow get: if isExistingOwner(resource.data.customerId);
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.customerId) && isOwnerFieldImmutable('customerId');
      allow delete: if isExistingOwner(resource.data.customerId);

      /**
       * @description Manages the individual items within an order. Access is inherited from the parent order.
       * @path /orders/{orderId}/orderItems/{orderItemId}
       * @allow (read, write) A user can access the items belonging to their own order.
       * @deny (read, write) A user cannot access items from an order that is not theirs.
       * @principle Enforces inherited access control from a parent document.
       */
      match /orderItems/{orderItemId} {
        allow get: if isOrderOwner(orderId);
        allow list: if isOrderOwner(orderId);
        allow create: if isOrderOwner(orderId);
        allow update: if isOrderOwner(orderId);
        allow delete: if isOrderOwner(orderId);
      }
    }

    /**
     * @description Manages public blog posts.
     * @path /blogPosts/{blogPostId}
     * @allow (get, list) Anyone, including unauthenticated users, can read blog posts.
     * @deny (create, update, delete) All client-side writes are forbidden.
     * @principle Enforces public read access for data managed by a trusted backend.
     */
    match /blogPosts/{blogPostId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}
